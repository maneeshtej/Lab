#include <mpi.h>
#include <stdio.h>
#include <stdlib.h>


int main(int argc, char *argv[]) {


    MPI_Init(&argc, &argv);


    int rank, size;
    MPI_Comm_rank(MPI_COMM_WORLD, &rank);
    MPI_Comm_size(MPI_COMM_WORLD, &size);


    // Let MPI decide best grid dimensions for 2D topology
    int dims[2] = {0, 0};
    MPI_Dims_create(size, 2, dims);


    int periods[2] = {0, 0};    // No wrap-around (non-periodic grid)
    int reorder = 1;            // Allow MPI to reorder ranks for efficiency


    MPI_Comm cart_comm;
    MPI_Cart_create(MPI_COMM_WORLD, 2, dims, periods, reorder, &cart_comm);


    if (cart_comm == MPI_COMM_NULL) {
        if (rank == 0)
            printf("Could not create Cartesian topology\n");
        MPI_Finalize();
        return 0;
    }


    // Get coordinates in the 2D grid
    int coords[2];
    MPI_Cart_coords(cart_comm, rank, 2, coords);
    printf("[Rank %d] coords = (%d, %d)\n", rank, coords[0], coords[1]);


    // Find neighbors: up, down, left, right
    int up, down, left, right;


    MPI_Cart_shift(cart_comm, 0, 1, &up,  &down);  // Vertical move: rows
    MPI_Cart_shift(cart_comm, 1, 1, &left, &right); // Horizontal move: columns


    printf("[Rank %d] neighbors -> up: %d, down: %d, left: %d, right: %d\n",
           rank, up, down, left, right);


    MPI_Finalize();
    return 0;
}




// mpicc program9.c -o program9
// mpirun -np 4 ./program9






// mpirun -np 4 ./program9
// mpirun -np 6 ./program9
// mpirun -np 9 ./program9